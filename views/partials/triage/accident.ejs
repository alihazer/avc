<!-- views/triage/emergency.ejs -->

<!-- Html2pdf -->
<div id="content1">
    <div class="tables-container">
        <div class="common-fields-table">
            <!-- Common Fields Table -->
            <table>
                <tr>
                    <th>Time</th>
                    <td><%= triage.createdAt ? moment(triage.createdAt).format('DD-MM-YYYY') : 'N/A' %> - <%= triage.time || 'N/A' %></td>
                </tr>
                <tr>
                    <th>Car Number</th>
                    <td><%= triage.car_nb || 'N/A' %></td>
                </tr>
                <tr>
                    <th>From</th>
                    <td><%= triage.from || 'N/A' %></td>
                </tr>
                <tr>
                    <th>To</th>
                    <td><%= triage.to || 'N/A' %></td>
                </tr>
                <tr>
                    <th>Driver Name</th>
                    <td><%= triage.driver?.username || 'N/A' %></td>
                </tr>
                <tr>
                    <th>Paramedics</th>
                    <td>
                        <ul>
                            <% if (triage.paramedics?.length) { %>
                                <% triage.paramedics.forEach(paramedic => { %>
                                    <li><%= paramedic.username || 'N/A' %></li>
                                <% }); %>
                            <% } else { %>
                                <li>N/A</li>
                            <% } %>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <th>Patient Name</th>
                    <td id="name"><%= triage.patient_name || 'N/A' %></td>
                </tr>
            </table>
        </div>
        <div class="emergency-table">
            <!-- Emergency Table -->
            <table>
                <tr>
                    <th>AVPU</th>
                    <td>
                        <% if (triage.avpu) { %>
                            <% if (triage.avpu === "Alert") { %>
                                <span style="color: green;"><%= triage.avpu %> -> PPTE -> <%= triage.ppte || 'N/A' %></span>
                            <% } else if (triage.avpu === "Verbal") { %>
                                <span style="color: orange;"><%= triage.avpu %></span>
                            <% } else if (triage.avpu === "Pain") { %>
                                <span style="color: red;"><%= triage.avpu %></span>
                            <% } else if (triage.avpu === "Unresponse") { %>
                                <span style="color: black;"><%= triage.avpu %></span>
                            <% } else { %>
                                <%= triage.avpu %>
                            <% } %>
                        <% } else { %>
                            N/A
                        <% } %>
                    </td>
                </tr>
                <tr>
                    <th>MOI</th>
                    <td>
                        <ul>
                            <% if (triage.moi?.length) { %>
                                <% triage.moi.forEach(moi => { %>
                                    <li><%= moi.name || 'N/A' %></li>
                                <% }); %>
                            <% } else { %>
                                <li>N/A</li>
                            <% } %>
                        </ul>
                    </td>
                </tr>
                <!-- DCAP_BTLS -->
                <tr>
                    <th>DCAP_BTLS</th>
                    <% const trueLetters = triage.dcap_btls
                        ? Object.entries(triage.dcap_btls)
                              .filter(([key, value]) => value)
                              .map(([key]) => letters[key])
                        : []; %>
                    <td>
                        <ul>
                            <% if (trueLetters.length) { %>
                                <% trueLetters.forEach(letter => { %>
                                    <li><%= letter %></li>
                                <% }); %>
                            <% } else { %>
                                <li>N/A</li>
                            <% } %>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <th>Vitals</th>
                    <td>
                        <ul>
                            <li>Heart Rate: <%= triage.vitals?.heartRate || 'N/A' %></li>
                            <li>Blood Pressure: <%= triage.vitals?.bloodPressure || 'N/A' %></li>
                            <li>SPO2: <%= triage.vitals?.spo2 || 'N/A' %></li>
                            <li>Temperature: <%= triage.vitals?.temperature || 'N/A' %></li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <th>Medical History</th>
                    <td>
                        <ul>
                            <% if (triage.medicalHistory?.length) { %>
                                <% triage.medicalHistory.forEach(history => { %>
                                    <li><%= history.name || 'N/A' %></li>
                                <% }); %>
                            <% } else { %>
                                <li>N/A</li>
                            <% } %>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <th>Surgical History</th>
                    <td>
                        <ul>
                            <% if (triage.surgicalHistory?.length) { %>
                                <% triage.surgicalHistory.forEach(history => { %>
                                    <li><%= history.name || 'N/A' %></li>
                                <% }); %>
                            <% } else { %>
                                <li>N/A</li>
                            <% } %>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <th>Usage</th>
                    <td>
                        <ul>
                            <% if (triage.usage?.length) { %>
                                <% triage.usage.forEach(usage => { %>
                                    <li><%= usage._id?.name || 'N/A' %> - Quantity: <%= usage.quantity || 'N/A' %></li>
                                <% }); %>
                            <% } else { %>
                                <li>N/A</li>
                            <% } %>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <th>Notes</th>
                    <td><%= triage.notes || 'N/A' %></td>
                </tr>
                <tr>
                    <th>Approval Number</th>
                    <td><%= triage.approval_nb || 'N/A' %></td>
                </tr>
            </table>
        </div>
    </div>
    <button id="download" class="btn btn-primary" onclick="downloadPdf(`<%= triage.patient_name || 'N/A' %>`, `<%= triage.createdAt ? moment(triage.createdAt).format('DD-MM-YYYY') : 'N/A' %>`)">
        Download PDF
    </button>
</div>

<script>
    function downloadPdf(name, date) {
        const content = document.getElementById('content1');
        const downloadBtn = document.getElementById('download');
        downloadBtn.style.display = 'none';
        const sanitizedPatientName = name.replace(/\s/g, '_');
        const options = {
            margin: [-1, 0, 0, 0],
            filename: `${sanitizedPatientName}_${date || 'N/A'}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: [8.5, 14], orientation: 'portrait' }
        };
        html2pdf()
            .from(content)
            .set(options)
            .toPdf()
            .get('pdf')
            .then(pdf => {
                pdf.save(options.filename);
                window.location.href = '/dashboard';
            });
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
